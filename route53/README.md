# Route53 CDK8s Setup

## Table of Contents

- [Route53 CDK8s Setup](#route53-cdk8s-setup)
  - [Table of Contents](#table-of-contents)
  - [Overview](#overview)
  - [Crossplane Dependencies](#crossplane-dependencies)
  - [Directory Structure:](#directory-structure)
  - [Updating the configuration YAML files](#updating-the-configuration-yaml-files)
    - [awstags.yaml - AWS Resource Tags](#awstagsyaml---aws-resource-tags)
    - [k8stags.yaml - Kubernetes annotations tags](#k8stagsyaml---kubernetes-annotations-tags)
    - [route53.yaml - DNS Configuration](#route53yaml---dns-configuration)
  - [Executing the CDK8s](#executing-the-cdk8s)
    - [Install dependencies](#install-dependencies)
    - [Create CDK8s manifests](#create-cdk8s-manifests)

## Overview

This project leverages CDK8s to manage AWS Route 53 resources such as hosted zones and DNS records. The infrastructure is defined using TypeScript, and manifests are generated and deployed via Crossplane. Tags for AWS resources and Kubernetes annotations are stored in YAML files, allowing for dynamic configuration. The CDK8s setup enables easy management of DNS entries and Route 53 configurations using Kubernetes-native resources.

## Crossplane Dependencies

This code was written with [Upbound AWS Providers Version 11.0](https://marketplace.upbound.io/providers/upbound/provider-family-aws/v1.11.0/providers?)

To deploy the created tempaltes, the kubernetes cluster must be running [provider-aws-route53](https://marketplace.upbound.io/providers/upbound/provider-aws-route53/latest)

## Directory Structure:

- **`bin/`**: This directory contains the executable TypeScript files that define command-line tools or scripts for the project. The files in `bin/` are typically compiled to JavaScript and mapped to commands via the `bin` field in `package.json`, making them directly executable through the command line. These scripts are responsible for high-level tasks like deploying infrastructure or running specific commands related to the projectâ€™s functionality.
  
- **`lib/`**: The `lib/` directory is used to store the core logic and reusable modules of the project. These TypeScript files contain the main business logic, utilities, or helper functions that are imported and used by other parts of the application, including the scripts in `bin/`. The files in `lib/` are designed to be modular and maintainable, focusing on the core operations behind the scenes, which are separated from the command-line interface.
  
- **`configs/`**: This directory stores configuration templates in formats such as YAML or JSON. These files typically contain structured data, like arrays or key-value pairs, which are parsed and used by the project at runtime. For example, a DNS list in YAML format is stored in `configs/`, providing a configurable source of data that the scripts in `bin/` or modules in `lib/` can read and process dynamically. This allows for easy updates to the configuration without modifying the code itself.

## Updating the configuration YAML files

### awstags.yaml - AWS Resource Tags

The `awstags.yaml` file contains key-value pairs that define AWS resource tags. These tags are applied to the AWS Route 53 resources (e.g., hosted zones) generated by CDK8s. The structure is simple and looks like this:

```yaml
tags:
  - key: owner
    value: john.doe
  - key: environment
    value: dev
```

You can modify this file to add or remove tags. The tags will be applied to the AWS resources during the synthesis of the manifests.

### k8stags.yaml - Kubernetes annotations tags

The `k8stags.yaml` file contains Kubernetes annotations in the same key-value format as the AWS tags. These annotations are applied to Kubernetes resources such as hosted zones in the manifests. Example:

```yaml
tags:
  - key: app
    value: dns-service
  - key: team
    value: networking
```

These annotations can be modified in the `k8stags.yaml` file and will be included in the metadata of the Kubernetes resources when manifests are generated.

### route53.yaml - DNS Configuration

The `route53.yaml` file contains the DNS configuration for AWS Route 53. It includes domain names, record sets, and DNS settings for each domain. An example entry looks like:

```yaml
example.com:
  hosted_zone_name: example.com
  record_sets:
    - name: www.example.com.
      type: A
      ttl: 3600
      values:
        - 192.0.2.44
    - name: example.com.
      type: MX
      ttl: 300
      values:
        - '10 mail.example.com.'
```

Modify this file to add, remove, or update DNS records, which will be reflected in the generated manifests for Route 53.

## Executing the CDK8s

### Install dependencies

To set up the project, make sure that all dependencies are installed by running the following command in the project root directory:

```bash
npm install
```

This will install the required packages like `cdk8s`, `cdk8s-cli`, and others necessary for generating Kubernetes manifests.

### Create CDK8s manifests

Once dependencies are installed and the configuration files are updated, you can generate the Kubernetes manifests by running:

```bash
cdk8s synth
```